<html>
<head>
    <title>PlayStation&trade; Network Database</title>
</head>
<script>
    javascript: window.resizeTo(screen.width, screen.height)
</script>
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: url("https://ps3-pro.github.io/PSN-Content/resources/media/background.png") no-repeat center center fixed;
        background-size: cover;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
    }

    header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 130px;
        padding: 10px 15px;
        background: rgba(0, 0, 0, 0.6);
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        border-bottom: 2px solid #888;
        display: block;
        z-index: 2;
    }

    header a {
        font-size: 3em;
        color: #ffffff;
        text-decoration: none;
        font-weight: bold;
        display: block;
    }

    header a:hover {
        color: #66ccff;
    }

    #selection-menu {
        position: fixed;
        top: 128px;
        /* justo em cima da borda superior da sidebar */
        left: 0;
        right: 0;
        height: 28px;
        background: rgba(0, 0, 0, 0.0);
        /* transparente para não alterar o visual */
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        z-index: 6;
        font-size: 1em;
    }

    #selection-menu a {
        color: #fff;
        text-decoration: none;
        font-weight: bold;
    }

    #selection-menu a:hover {
        color: #66ccff;
    }

    form {
        margin: 10px auto;
    }

    input[type="search"],
    input[type="submit"],
    input[type="button"] {
        font-size: 1.2em;
        padding: 6px 10px;
        margin: 5px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #aaa;
        color: #fff;
        border-radius: 5px;
    }

    input[type="search"] {
        width: 250px;
    }

    button {
        margin: 2px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #aaa;
        color: #fff;
        border-radius: 4px;
        font-size: 1em;
        padding: 3px 6px;
    }

    button:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    #main.table {
        display: table;
        width: 100%;
        height: 100%;
        table-layout: fixed;
    }

    .table-cell {
        display: table-cell;
        vertical-align: top;
    }

    .sidebar {
        position: fixed;
        top: 150px;
        bottom: 0;
        left: 0;
        width: 80px;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        padding: 0 5px 5px 5px;
        box-sizing: border-box;
        border-right: 2px solid #888;
        z-index: 3;
    }

    .sidebar-top-border {
        position: fixed;
        top: 152px;
        bottom: 0;
        left: 5px;
        width: 90px;
        height: 2px;
        background: rgba(0, 8, 30, 1);
        margin-top: -2px;
        margin-left: -7px;
        z-index: 4;
    }

    .sidebar-right {
        position: fixed;
        top: 150px;
        bottom: 0;
        right: 0;
        width: 80px;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        padding: 0 5px 5px 5px;
        box-sizing: border-box;
        border-left: 2px solid #888;
        z-index: 3;
    }

    .sidebar-right-top-border {
        position: fixed;
        top: 152px;
        right: 5px;
        width: 90px;
        height: 2px;
        background: rgba(0, 8, 30, 1);
        margin-top: -2px;
        margin-right: -7px;
        z-index: 4;
    }

    .sidebar ul,
    .sidebar-right ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar ul li,
    .sidebar-right ul li {
        margin: 5px 0;
    }

    .sidebar ul li a,
    .sidebar-right ul li a {
        text-decoration: underline;
        font-size: 1.2em;
        display: block;
        color: #ffffff;
    }

    .sidebar ul li a:hover,
    .sidebar-right ul li a:hover {
        color: #ffff00;
    }

    .sidebar ul li a:active,
    .sidebar-right ul li a:active {
        color: #0000ff;
    }

    #letters {
        margin-top: 40px;
    }

    #letters a {
        width: 100%;
        text-align: center;
        margin: 2px 0;
        display: block;
        color: #ffffff;
    }

    #license-links {
        margin-top: 20px;
    }

    #license-links a {
        width: 100%;
        text-align: center;
        margin: 2px 0;
        display: block;
        color: #ffffff;
        font-size: 0.9em;
    }

    .content {
        padding-right: 0px;
        text-align: center;
    }

    ul#list {
        position: relative;
        top: 170px;
        width: auto;
        max-width: 800px;
        list-style: none;
        padding: 10px 20px;
        margin: 0 auto;
        display: inline-block;
        text-align: left;
        font-size: 1em;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        white-space: normal;
        /* nowrap */
        min-width: 400px;
        z-index: 1;
    }

    ul#list li {
        padding: 8px 10px;
        border-bottom: 1px solid #333;
    }

    ul#list li a {
        text-decoration: none;
        color: #fff;
    }

    ul#list li a:hover {
        text-decoration: underline;
        color: #66ccff;
    }

    [download] {
        background: #fff;
        color: #000 !important;
        padding: 2px 6px;
        margin-left: 10px;
        text-decoration: none;
        border-radius: 3px;
        font-size: 0.9em;
    }

    #icon {
        width: 64px;
        height: auto;
        margin: 10px auto;
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #aaa;
    }

    #backToTop {
        position: fixed;
        bottom: 20px;
        right: 110px;
        padding: 10px 16px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-weight: bold;
        border: 2px solid #888;
        border-radius: 8px;
        cursor: pointer;
        z-index: 15;
    }

    #backToTop:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    #selection-menu a.active {
        color: #66ccff;
        text-decoration: underline;
    }
</style>

<body>
    <header>
        <a href="">PlayStation&trade; Network Database</a>
        <div id="count" aria-live="polite" role="status">Loading</div>
        <form name="engine" onsubmit="location.hash=query.value;render();return false">
            <input type="search" name="query" size="25" placeholder="Search">
            <input type="submit" name="send" value="Search" disabled>
            <input type="button" name="fetch" value="Reload DB" onclick="fetchDB()">
        </form>
    </header>

    <div id="selection-menu" aria-hidden="false">
        <a href="#" id="ln-avatar">Avatars</a>
        <a href="#" id="ln-demos">Demos</a>
        <a href="#" id="ln-dlcs">DLCs</a>
        <a href="#" id="ln-game">Games</a>
        <a href="#" id="ln-themes">Themes</a>
    </div>

    <div id="main" class="table">
        <div class="sidebar table-cell" id="sidebar">
            <div class="sidebar-top-border"></div>
            <ul id="letters"></ul>
        </div>
        <div class="content table-cell">
            <ul id="list"></ul>
        </div>
        <div class="sidebar-right" id="sidebar-right">
            <div class="sidebar-right-top-border"></div>
            <ul id="license-links">
                <li><a href="https://github.com/PS3-Pro/License-Files/releases/download/Licenses/License_Pack_Bin.pkg">License
                        Pack</a></li>
            </ul>
        </div>
        <button id="backToTop" onclick="scrollToTop()">&#8593; Top</button>

<script>
    function scrollToTop() {
        window.scrollTo(0, 0);
    }

    // *** NOVA FUNÇÃO ***
    // Adicionei esta função para formatar o tamanho (que vem em bytes)
    function formatBytes(bytes, decimals = 2) {
        if (bytes == 0) return '(0 Bytes)';
        if (isNaN(parseInt(bytes))) return ''; // Trata valores não numéricos
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return '(' + parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i] + ')';
    }

    function sort(lines, algo) {
        for (var i = 0; i < lines.length; i++) {
            for (var j = 0; j < lines.length - i - 1; j++) {
                if (algo(lines[j], lines[j + 1])) {
                    var temp = lines[j];
                    lines[j] = lines[j + 1];
                    lines[j + 1] = temp;
                }
            }
        }
        return lines;
    }

    try {
        var f = document.forms.engine;
        var dbPath = "../resources/database/PS3_GAMES.tsv"; // Caminho inicial
        var DB = window.localStorage ? JSON.parse(localStorage.DB || '[]') : [];

        // *** FUNÇÃO ATUALIZADA ***
        // Corrigida para usar as colunas do TSV
        function makeRap(row) {
            var hex = row[4];       // Coluna [4] é o zRIF
            var contentID = row[5]; // Coluna [5] é o Content ID

            // Adicionado "MISSING" na verificação
            if (!hex || hex == 0 || hex === 'MISSING') return '<span> - Missing RAP</span>';
            
            // O nome correto do arquivo RAP é o Content ID
            // Usando o link do yne.fr que é comum para isso
            return '<a download="' + contentID + '.rap" href="http://yne.fr/psndl/' + hex + '.rap">RAP</a>';
        }

        // *** FUNÇÃO ATUALIZADA ***
        // Agora pula a primeira linha (cabeçalho) do TSV
        function fetchDB() {
            f.fetch.disabled = true;
            var xhr = new XMLHttpRequest();
            xhr.onabort = xhr.ontimeout = xhr.onerror = function () {
                alert("Error loading DB");
                f.fetch.disabled = false;
            };
            xhr.onload = function () {
                if (xhr.status != 200) {
                    alert("Status " + xhr.status);
                    f.fetch.disabled = false;
                    return;
                }

                var lines = xhr.responseText.split("\n");

                // Pula a primeira linha (cabeçalho) do TSV
                if (lines.length > 0) {
                    lines.shift();
                }

                // Transforma em array e filtra linhas vazias
                DB = lines.map(function(line) {
                    return line.split("\t");
                }).filter(function(row) {
                    return row.length > 7; // Garante que é uma linha de dados válida
                });

                if (window.localStorage) {
                    try {
                        localStorage.DB = JSON.stringify(DB);
                    } catch (e) {
                        console.error("Falha ao salvar no LocalStorage: ", e);
                        localStorage.removeItem("DB"); // Limpa se estiver cheio
                    }
                }
                f.fetch.disabled = false;
                render();
            };
            xhr.open('GET', dbPath);
            xhr.send();
        }

        // *** FUNÇÃO ATUALIZADA ***
        // Mapeada para as colunas corretas do TSV
        function render() {
            f.fetch.type = window.localStorage ? 'button' : 'hidden';
            f.send.disabled = DB.length == 0;
            f.query.placeholder = DB.length + " items found";

            var query = decodeURIComponent(location.hash.replace(/^#+/, ''));
            var startsWith = query.length && query[0] == '^';
            var rule = new RegExp(query, 'i');

            var matches = [];
            // Colunas do TSV: [2] = Nome, [5] = Content ID
            for (var i = 0; i < DB.length && matches.length < (startsWith ? 999 : 99); i++) {
                // Busca por Nome ([2]) ou por Content ID ([5])
                if (DB[i][2] && DB[i][2].match(rule) || (DB[i][5] == query)) {
                    matches.push(DB[i]);
                }
            }

            // Ordena pelo Nome (Coluna [2])
            sort(matches, function (a, b) { return a[2] > b[2]; });

            for (var i = 0; i < matches.length; i++) {
                var a = matches[i];
                // Colunas do TSV:
                // a[3] = PKG direct link
                // a[2] = Nome
                // a[7] = File Size (bytes)
                // a[5] = Content ID
                matches[i] = '<li><a href="' + a[3] + '">' + a[2] + ' ' + formatBytes(a[7]) + ' [' + a[5] + "]</a> " + makeRap(a) + "</li>";
            }
            document.getElementById('list').innerHTML = matches.join('');
            document.getElementById('count').textContent = "Displaying " + matches.length + " items";
        }

        // Criar links laterais
        var links = '<a href="#" onclick="location.hash=\'^[0-9]\';render()">[0-9]</a>';
        for (var c = 65; c < 91; c++) {
            links += '<a href="#" onclick="location.hash=\'^\'+this.innerHTML;render()">' + String.fromCharCode(c) + '</a>';
        }
        document.getElementById("letters").innerHTML = links;

        function selectCategory(cat) {
            switch(cat) {
                case "games": dbPath = "https://nopaystation.com/tsv/PS3_GAMES.tsv"; break;
                case "avatars": dbPath = "https://nopaystation.com/tsv/PS3_AVATARS.tsv"; break;
                case "demos": dbPath = "https://nopaystation.com/tsv/PS3_DEMOS.tsv"; break;
                case "dlcs": dbPath = "https://nopaystation.com/tsv/PS3_DLCS.tsv"; break;
                case "themes": dbPath = "https://nopaystation.com/tsv/PS3_THEMES.tsv"; break;
            }

            DB = [];
            if (window.localStorage) localStorage.DB = "[]";

            location.hash = "";
            f.query.value = "";

            // Atualiza links laterais
            var links = '<a href="#" onclick="location.hash=\'^[0-9]\';render()">[0-9]</a>';
            for (var c = 65; c < 91; c++) {
                links += '<a href="#" onclick="location.hash=\'^\'+this.innerHTML;render()">' + String.fromCharCode(c) + '</a>';
            }
            document.getElementById("letters").innerHTML = links;

            // Atualiza menu ativo
            var menu = document.getElementById("selection-menu").getElementsByTagName("a");
            for (var i = 0; i < menu.length; i++) {
                menu[i].className = menu[i].className.replace("active", "");
            }
            var idMap = {games:"ln-game", avatars:"ln-avatar", demos:"ln-demos", dlcs:"ln-dlcs", themes:"ln-themes"};
            document.getElementById(idMap[cat]).className += " active";

            fetchDB();
        }

        // Adiciona os event handlers para os links do menu
        // (Isso estava faltando no seu script anterior, pode causar bugs se não tiver)
        document.getElementById("ln-avatar").onclick = function(e) { e.preventDefault(); selectCategory("avatars"); };
        document.getElementById("ln-demos").onclick = function(e) { e.preventDefault(); selectCategory("demos"); };
        document.getElementById("ln-dlcs").onclick = function(e) { e.preventDefault(); selectCategory("dlcs"); };
        document.getElementById("ln-game").onclick = function(e) { e.preventDefault(); selectCategory("games"); };
        document.getElementById("ln-themes").onclick = function(e) { e.preventDefault(); selectCategory("themes"); };

        selectCategory("games"); // Inicia com games

    } catch (a) {
        alert(a);
    }
</script>
    </body>
</html>