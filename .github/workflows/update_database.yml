name: Update PSNâ„¢ Database

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  update-database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Official TSV files from NoPayStation
        run: |
          BASE_DIR="resources/database/official"
          
          mkdir -p "$BASE_DIR/pending"

          curl -L "https://nopaystation.com/tsv/PS3_GAMES.tsv" -o "$BASE_DIR/games.tsv"
          curl -L "https://nopaystation.com/tsv/PS3_AVATARS.tsv" -o "$BASE_DIR/avatars.tsv"
          curl -L "https://nopaystation.com/tsv/PS3_DEMOS.tsv" -o "$BASE_DIR/demos.tsv"
          curl -L "https://nopaystation.com/tsv/PS3_DLCS.tsv" -o "$BASE_DIR/dlcs.tsv"
          curl -L "https://nopaystation.com/tsv/PS3_THEMES.tsv" -o "$BASE_DIR/themes.tsv"

          curl -L "https://nopaystation.com/tsv/pending/PS3_GAMES.tsv" -o "$BASE_DIR/pending/games.tsv"
          curl -L "https://nopaystation.com/tsv/pending/PS3_AVATARS.tsv" -o "$BASE_DIR/pending/avatars.tsv"
          curl -L "https://nopaystation.com/tsv/pending/PS3_DEMOS.tsv" -o "$BASE_DIR/pending/demos.tsv"
          curl -L "https://nopaystation.com/tsv/pending/PS3_DLCS.tsv" -o "$BASE_DIR/pending/dlcs.tsv"
          curl -L "https://nopaystation.com/tsv/pending/PS3_THEMES.tsv" -o "$BASE_DIR/pending/themes.tsv"

      - name: Commit and Push changes
        run: |
          git config --global user.name "PS3-Pro Bot"
          git config --global user.email "bot@ps3pro.com"
          
          git add resources/database/official/*.tsv
          git add resources/database/official/pending/*.tsv
          
          git diff-index --quiet HEAD || git commit -m "Auto-update: Synchronized with NoPayStation (Official & Pending)"
          git push